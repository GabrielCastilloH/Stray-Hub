# Backend API — Stray Hub

FastAPI REST API for profiles, sightings, and match management. Connects to Firestore, Cloud Storage, and the ML embedding service.

---

## Overview

| Item | Value |
|------|-------|
| **Port** | 8001 |
| **Framework** | FastAPI |
| **Database** | Cloud Firestore |
| **Storage** | Firebase Cloud Storage |
| **ML Service** | `http://localhost:8000` (configurable) |
| **Docs** | `/docs` (Swagger) |

---

## Quick Start

```bash
cd backend && pip install -r requirements.txt
uvicorn backend.main:app --port 8001 --reload
# Or with emulators: ./scripts/start_dev.sh
```

---

## Configuration

`.env` at project root (pydantic-settings, prefix `STRAY_`):

| Variable | Description |
|----------|-------------|
| `STRAY_FIREBASE_CREDENTIALS_PATH` | Absolute path to service account JSON |
| `STRAY_STORAGE_BUCKET` | e.g. `stray-hub.firebasestorage.app` |
| `STRAY_ML_SERVICE_URL` | Default `http://localhost:8000` |

**Emulator mode**: Set `FIRESTORE_EMULATOR_HOST` → backend skips credentials and uses local emulators.

---

## API Endpoints

### Health
- `GET /api/v1/health` — Health check

### Profiles
- `POST /api/v1/profiles` — Create profile
- `GET /api/v1/profiles` — List (cursor pagination, optional `species`)
- `GET /api/v1/profiles/{id}` — Get one
- `PATCH /api/v1/profiles/{id}` — Update
- `POST /api/v1/profiles/{id}/photos` — Add photo (max 5)

### Sightings
- `POST /api/v1/sightings` — Single photo upload (multipart: file, lat, lng, notes, disease_tags)
- `POST /api/v1/sightings/pipeline` — Multi-photo upload + embed + match (returns match candidates)
- `GET /api/v1/sightings` — List (cursor, optional `status`)
- `GET /api/v1/sightings/{id}` — Get one
- `POST /api/v1/sightings/{id}/embed` — Re-run embedding for existing sighting

### Matches
- `GET /api/v1/matches/{sighting_id}` — Get match result for a sighting

---

## Data Flow

**Single-photo sighting:**
```
POST /sightings → resize 224×224 → upload original + resized → Firestore
```

**Pipeline (multi-photo + match):**
```
POST /sightings/pipeline → for each photo: upload + resize → POST ML /embed
→ average embeddings, L2-normalize → Firestore
→ fetch other sightings with embeddings → cosine similarity (≥0.7)
→ write matches/{id} if any → return PipelineResponse
```

---

## Conventions

- **Pagination**: Cursor-based via `start_after` (Firestore doc ID). No offset.
- **Sighting IDs**: UUID generated by backend; used for both Firestore doc and Storage path. Use `.document(id).set()`, not `.add()`.
- **Image resizing**: All sighting images resized to 224×224 (Pillow `LANCZOS`) before storing. Both original and resized kept.
- **Disease tags**: Comma-separated in form (`disease_tags=rabies,mange`). Enum: `rabies`, `mange`, `distemper`, `parvovirus`, `other`.
- **Signed URLs**: 60 min default. Emulator returns direct URLs (no signing).

---

## Directory Structure

```
backend/
├── main.py           # FastAPI app, routers
├── config.py         # pydantic-settings
├── dependencies.py   # Firebase init, Firestore/Storage access
├── routers/          # health, profiles, sightings, matches
├── models/           # Pydantic schemas
├── services/         # firestore_service, storage_service
└── tests/
```

---

## Firestore Schema (Summary)

- `profiles/{id}` — name, species, sex, breed, etc. + `photos` subcollection
- `sightings/{id}` — location, notes, disease_tags, embedding (32 floats), model_version, status
- `matches/{sighting_id}` — candidates, status, confirmed_profile_id

---

## Storage Paths

```
profiles/{id}/photos/{photo_id}.jpg
sightings/{id}/photo.jpg, photo_224.jpg
sightings/{id}/photo_{i}.jpg, photo_{i}_224.jpg  (pipeline)
```

---

## Tests

```bash
python -m pytest backend/tests/ -v
```

Use `PIL.Image.new()` for valid test images. Fake JPEG bytes (`b"\xff\xd8..."`) crash the resize step.

---

## Pitfalls

- `STRAY_FIREBASE_CREDENTIALS_PATH` must be **absolute**. Relative paths fail depending on cwd.
- `.env` format: `KEY=VALUE` only — no `export`, no line wrapping.
- Don't use Firestore `.add()` for sightings — ID mismatch with Storage paths.
